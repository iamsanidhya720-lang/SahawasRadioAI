<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahawas AI - Medical Report Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: 
                linear-gradient(rgba(0, 20, 40, 0.85), rgba(0, 30, 60, 0.90)),
                url('https://i.ibb.co/hRSg34FD/background.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            color: white;
            position: relative;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(0, 20, 40, 0.95), rgba(0, 30, 60, 0.98)),
                url('https://i.ibb.co/wFRqwMd/medical-background.jpg');
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeOut 0.8s ease-out 4s forwards;
        }
        
        .loading-text {
            font-family: 'Times New Roman', serif;
            font-size: 1.5rem;
            font-weight: normal;
            color: #ffffff;
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.7);
            opacity: 0;
            transform: translateY(30px);
            animation: slideInFade 1.5s ease-out 0.5s forwards, textPulse 2s ease-in-out 2s infinite;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite, spinScale 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }
        
        @keyframes fadeOut {
            to { opacity: 0; pointer-events: none; }
        }
        
        @keyframes slideInFade {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes textPulse {
            0%, 100% { 
                opacity: 1; 
                text-shadow: 0 2px 10px rgba(0,0,0,0.7);
            }
            50% { 
                opacity: 0.8; 
                text-shadow: 0 2px 20px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.2);
            }
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        @keyframes spinScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* WhatsApp Button */
        .whatsapp-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #25d366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .whatsapp-btn:hover {
            transform: scale(1.1);
        }

        .whatsapp-btn::before {
            content: "ðŸ“ž";
            font-size: 24px;
        }

        /* Container and Layout */
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 30px 20px; 
            position: relative; 
        }
        
        /* Header */
        .header { 
            text-align: center; 
            margin-bottom: 60px; 
            padding-top: 40px;
        }
        
        .header h1 { 
            font-family: 'Poppins', sans-serif;
            font-size: 3.5rem; 
            font-weight: 600; 
            margin-bottom: 20px; 
            color: #ffffff;
            letter-spacing: -1px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.6);
            background: linear-gradient(135deg, #ffffff 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p { 
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 1.1rem; 
            opacity: 0.9; 
            line-height: 1.6; 
            font-weight: 300;
            max-width: 450px;
            margin: 0 auto;
            text-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }

        /* Form Sections */
        .form-section { 
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(25px); 
            border-radius: 16px; 
            padding: 36px; 
            margin-bottom: 28px; 
            border: 1px solid rgba(255,255,255,0.25);
            box-shadow: 0 8px 32px rgba(0, 20, 40, 0.3);
        }
        
        .form-title { 
            font-family: 'Poppins', sans-serif;
            font-size: 1.3rem; 
            font-weight: 600;
            margin-bottom: 28px; 
            color: #ffffff;
            letter-spacing: 0.3px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }
        
        /* Radio Group */
        .radio-group { 
            display: flex; 
            gap: 24px; 
            margin-bottom: 0; 
            flex-wrap: wrap;
        }
        
        .radio-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            cursor: pointer;
            font-weight: 400;
            font-size: 0.95rem;
            color: rgba(255,255,255,0.9);
        }
        
        .radio-item input[type="radio"] { 
            width: 18px; 
            height: 18px; 
            accent-color: #3b82f6;
        }

        /* Upload Area */
        .upload-area { 
            border: 2px dashed rgba(255,255,255,0.3); 
            border-radius: 8px; 
            padding: 48px 24px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            margin-bottom: 0; 
        }
        
        .upload-area:hover { 
            border-color: rgba(255,255,255,0.5); 
            background: rgba(255,255,255,0.05); 
        }
        
        .upload-area.dragover { 
            border-color: #3b82f6; 
            background: rgba(59, 130, 246, 0.1); 
        }
        
        .upload-area p {
            margin: 8px 0;
            font-size: 0.95rem;
            color: rgba(255,255,255,0.8);
        }
        
        .upload-area p:first-child {
            font-weight: 500;
            font-size: 1rem;
            color: #ffffff;
        }
        
        .upload-icon { 
            font-size: 2.5rem; 
            margin-bottom: 16px; 
            opacity: 0.6; 
        }
        
        .file-input { display: none; }
        
        .image-preview { 
            max-width: 100%; 
            max-height: 300px;
            border-radius: 8px; 
            margin: 20px 0; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* Analyze Button */
        .analyze-btn { 
            width: 100%; 
            padding: 18px; 
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border: none; 
            border-radius: 12px; 
            color: white; 
            font-size: 1.1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            margin-top: 28px; 
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.3);
        }
        
        .analyze-btn:hover { 
            background: linear-gradient(135deg, #0099cc 0%, #007399 100%);
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }
        
        .analyze-btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.2);
        }

        /* Loading and Results */
        .loading { 
            display: none; 
            text-align: center; 
            padding: 28px;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(25px);
            border-radius: 16px;
            margin-top: 28px;
            border: 1px solid rgba(255,255,255,0.25);
            box-shadow: 0 8px 32px rgba(0, 20, 40, 0.3);
        }
        
        .loading p {
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: 400;
            font-size: 1.05rem;
            color: rgba(255,255,255,0.9);
        }
        
        .spinner { 
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top: 3px solid #00d4ff; 
            width: 45px; 
            height: 45px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px; 
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        .result-section { 
            display: none; 
            background: rgba(255,255,255,0.98); 
            color: #1a202c; 
            border-radius: 16px; 
            padding: 36px; 
            margin-top: 28px; 
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .result-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 28px; 
            flex-wrap: wrap; 
            gap: 20px; 
        }
        
        .result-header h2 { 
            font-family: 'Poppins', sans-serif;
            font-size: 1.6rem; 
            font-weight: 600;
            color: #1a202c; 
        }
        
        .export-btn { 
            padding: 12px 24px; 
            background: linear-gradient(135deg, #10b981, #059669);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .export-btn:hover { 
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .disclaimer { 
            background: #fef3c7; 
            border: 1px solid #f59e0b; 
            color: #92400e; 
            padding: 16px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            font-size: 0.9rem; 
        }
        
        .analysis-content { 
            line-height: 1.8; 
            font-family: 'Times New Roman', serif;
            font-size: 1.05rem;
            color: #2d3748;
        }
        
        .analysis-content h3 { 
            color: #1a202c; 
            margin: 28px 0 16px 0; 
            font-size: 1.3rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            border-left: 4px solid #00d4ff;
            padding-left: 16px;
        }
        
        .analysis-content ul { margin-left: 20px; margin-bottom: 16px; }
        .analysis-content li { margin-bottom: 8px; }

        /* Footer */
        .footer { 
            text-align: center; 
            margin-top: 60px; 
            padding: 32px 20px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 12px; 
        }
        
        .footer-links { 
            display: flex; 
            justify-content: center; 
            gap: 24px; 
            margin-bottom: 20px; 
        }
        
        .footer-links a { 
            font-size: 1.5rem;
            text-decoration: none;
            transition: transform 0.3s ease;
        }
        
        .footer-links a:hover {
            transform: scale(1.2);
        }

        .hospital-info h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .hospital-info p {
            font-size: 1.1rem;
            color: rgba(255,255,255,0.9);
            margin-bottom: 16px;
        }

        .owner-info {
            font-size: 0.95rem;
            margin-bottom: 16px;
            color: rgba(255,255,255,0.8);
        }

        .disclaimer-footer {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 12px;
        }

        .creator-info {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .form-section {
                padding: 24px;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 16px;
            }
            
            .result-header {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen">
        <div class="loading-text">You Will Be Fine ðŸ˜Š</div>
        <div class="loading-spinner"></div>
    </div>

    <a href="https://wa.me/919260692607" target="_blank" class="whatsapp-btn" title="Call Now"></a>

    <div class="container">
        <div class="header">
            <h1>Sahawas AI</h1>
            <p>Your personal AI health assistant. Get simple, clear explanations of your medical reports.</p>
        </div>

        <div class="form-section">
            <div class="form-title">
                <span>1.</span>
                <span>Select Report Type</span>
            </div>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" name="reportType" value="radiology" checked>
                    <span>Radiology (MRI, CT Scan)</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="reportType" value="pathology">
                    <span>Pathology (Blood, CBC)</span>
                </label>
            </div>
        </div>

        <div class="form-section">
            <div class="form-title">
                <span>2.</span>
                <span>Upload Report</span>
            </div>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ðŸ“„</div>
                <p><strong>Choose an Image</strong></p>
                <p>Drag & drop or click to select</p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept="image/*">
            <img id="imagePreview" class="image-preview" style="display: none;">
        </div>

        <button class="analyze-btn" onclick="analyzeReport()">
            <span id="analyzeText">ðŸ”¬ Analyze Report</span>
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your medical report...</p>
        </div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h2>AI Analysis</h2>
                <button class="export-btn" onclick="exportToPDF()">ðŸ“„ Export PDF</button>
            </div>
            <div class="disclaimer">
                <strong>Note:</strong> This is an AI-generated analysis for informational purposes only and should not be used for actual medical diagnosis. Always consult with a healthcare professional.
            </div>
            <div class="analysis-content" id="analysisContent"></div>
        </div>

        <div class="footer">
            <div class="footer-links">
                <a href="https://www.youtube.com" target="_blank" title="YouTube">ðŸ“º</a>
                <a href="https://www.instagram.com" target="_blank" title="Instagram">ðŸ“·</a>
            </div>
            <div class="hospital-info">
                <h3>Sahawas Hospital</h3>
                <p>9225109829</p>
            </div>
            <div class="owner-info">
                <strong>Owner:</strong> Dr. Sunil Sangle
            </div>
            <div class="disclaimer-footer">
                Disclaimer: This is an AI-generated analysis and not a substitute for professional medical advice.
            </div>
            <div class="creator-info">
                Created by Sanidhya S.
            </div>
        </div>
    </div>

    <script>
        let uploadedImageData = null;
        let analysisResult = '';
        let uploadedFile = null;

        // Google Gemini API Configuration
        const GEMINI_API_KEY = 'AIzaSyCxrRa2fjwmMWcvEKn2pB3AdXuUm3az0hg';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadArea = document.querySelector('.upload-area');

        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            uploadArea.classList.add('dragover'); 
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', handleFileDrop);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function handleFileDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file.');
                return;
            }

            uploadedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImageData = e.target.result;
                imagePreview.src = uploadedImageData;
                imagePreview.style.display = 'block';
                uploadArea.querySelector('p').innerHTML = `<strong>${file.name}</strong><br>Ready to analyze`;
            };
            reader.readAsDataURL(file);
        }

        // Convert file to base64 for API
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove the data:image/jpeg;base64, part
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        async function analyzeReport() {
            if (!uploadedImageData || !uploadedFile) {
                alert('Please upload an image first.');
                return;
            }

            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const loading = document.getElementById('loading');
            const analyzeBtn = document.querySelector('.analyze-btn');
            const resultSection = document.getElementById('resultSection');

            loading.style.display = 'block';
            analyzeBtn.disabled = true;
            document.getElementById('analyzeText').textContent = 'Analyzing with AI...';
            resultSection.style.display = 'none';

            try {
                console.log('Starting real AI analysis...');
                await performRealAIAnalysis(reportType);
                console.log('âœ… Real AI analysis completed successfully');
            } catch (error) {
                console.error('âŒ Real AI Analysis failed:', error);
                
                let errorMessage = '';
                let fallbackToDemo = false;
                
                if (error.message.includes('CORS_BLOCKED') || error.message.includes('NETWORK_ERROR')) {
                    errorMessage = `âš ï¸ **BROWSER LIMITATION DETECTED**

The Gemini AI API cannot be accessed directly from the browser due to CORS (Cross-Origin Resource Sharing) restrictions.

**Technical Issue:** ${error.message}

**Solutions:**
1. **For Production:** Set up a backend server to proxy API requests
2. **For Development:** Use a browser extension to disable CORS
3. **Alternative:** Deploy this code to a web server with backend support

**For Demo Purposes:** Would you like to see a simulated analysis to understand how the interface works?`;
                    
                    fallbackToDemo = true;
                } else if (error.message.includes('API_KEY_INVALID')) {
                    errorMessage = `ðŸ”‘ **API KEY ISSUE**
                    
The provided API key appears to be invalid or doesn't have the necessary permissions.

**Please check:**
- API key is correct and active
- API key has Gemini API access enabled
- Billing is set up for the Google Cloud project`;
                    
                } else if (error.message.includes('RATE_LIMIT')) {
                    errorMessage = `â³ **RATE LIMIT EXCEEDED**
                    
The API rate limit has been exceeded. Please wait a few minutes and try again.`;
                    
                } else {
                    errorMessage = `âŒ **ANALYSIS FAILED**
                    
Unexpected error: ${error.message}`;
                }
                
                // Show detailed error analysis
                displayAnalysis(errorMessage);
                
                if (fallbackToDemo) {
                    // Add a button to show demo analysis
                    setTimeout(() => {
                        const content = document.getElementById('analysisContent');
                        content.innerHTML += `<br><br><button onclick="showDemoAnalysis('${reportType}')" style="background: #10b981; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ðŸ“‹ Show Demo Analysis</button>`;
                    }, 1000);
                }
                
            } finally {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
                document.getElementById('analyzeText').innerHTML = 'ðŸ”¬ Analyze Report';
            }
        }

        // Demo analysis function for CORS issues
        window.showDemoAnalysis = function(reportType) {
            const demoAnalysis = generateDemoAnalysis(reportType);
            displayAnalysis(demoAnalysis);
        }

        function generateDemoAnalysis(reportType) {
            const timestamp = new Date().toLocaleString();
            
            if (reportType === 'radiology') {
                return `**DEMO AI ANALYSIS - CHEST X-RAY**
*This is a demonstration of how the real AI analysis would appear*

**IMAGING TECHNIQUE**
Posteroanterior and lateral chest radiographs were obtained using standard technique. Image quality is adequate for diagnostic interpretation with appropriate exposure and positioning.

**ANATOMICAL STRUCTURES**
The cardiac silhouette appears normal in size and configuration. Both hemidiaphragms are clearly visualized and appropriately positioned. The mediastinal contours are within normal limits. Pulmonary vasculature shows normal distribution and caliber.

**FINDINGS** 
The lungs are clear bilaterally with no evidence of focal consolidation, pleural effusion, or pneumothorax. No acute cardiopulmonary abnormality is identified. Bony structures appear intact with no obvious fractures or lesions visible.

**IMPRESSION**
Normal chest radiograph. No acute cardiopulmonary findings.

**RECOMMENDATIONS**
- Clinical correlation with patient symptoms
- Consider CT chest if clinical suspicion remains high despite normal radiograph
- Routine follow-up as clinically indicated

**IMPORTANT NOTE**
This is a **DEMONSTRATION** analysis showing the interface functionality. Real AI analysis requires proper backend integration to handle CORS restrictions.

*Generated: ${timestamp}*`;
            } else {
                return `**DEMO AI ANALYSIS - LABORATORY REPORT**
*This is a demonstration of how the real AI analysis would appear*

**IMAGING TECHNIQUE**
Laboratory analysis performed on submitted blood sample. Standard automated analyzer protocols utilized.

**FINDINGS**
Based on visible parameters in the uploaded report image:
- Complete Blood Count (CBC) values appear to be within reference ranges
- Basic metabolic panel shows normal kidney and liver function markers
- No critical values flagged in the visible results

**IMPRESSION**
Laboratory values appear grossly normal based on visible parameters. Detailed analysis requires clearer image quality for precise value extraction.

**RECOMMENDATIONS**
- Clinical correlation recommended
- Repeat testing if symptoms persist
- Consult with ordering physician for complete interpretation

**IMPORTANT NOTE**
This is a **DEMONSTRATION** analysis. Real AI would perform OCR (Optical Character Recognition) to extract exact values and provide detailed interpretation.

*Generated: ${timestamp}*`;
            }
        }

        async function performRealAIAnalysis(reportType) {
            try {
                console.log('ðŸ”„ Converting image to base64...');
                const base64Image = await fileToBase64(uploadedFile);
                const mimeType = uploadedFile.type;
                console.log(`ðŸ“¸ Image processed: ${mimeType}, size: ${base64Image.length} characters`);

                const prompt = getAnalysisPrompt(reportType);
                console.log(`ðŸ“ Generated prompt for ${reportType} analysis`);

                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: prompt
                            },
                            {
                                inline_data: {
                                    mime_type: mimeType,
                                    data: base64Image
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.4,
                        topK: 32,
                        topP: 1,
                        maxOutputTokens: 4096,
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH", 
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_NONE"
                        }
                    ]
                };

                console.log('ðŸš€ Sending request to Gemini API...');
                
                // Try with different fetch configurations to handle CORS
                const fetchOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                    mode: 'cors', // Explicitly set CORS mode
                    credentials: 'omit' // Don't send credentials
                };

                let response;
                try {
                    // First try with the standard API endpoint
                    response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, fetchOptions);
                } catch (corsError) {
                    console.log('ðŸ”„ CORS issue detected, trying alternative approach...');
                    
                    // Try with a CORS proxy as fallback
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`);
                    
                    try {
                        response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });
                    } catch (proxyError) {
                        console.error('âŒ Both direct and proxy requests failed');
                        throw new Error('CORS_BLOCKED: Cannot access Gemini API from browser. This is a browser security limitation.');
                    }
                }

                console.log(`ðŸ“¡ API Response status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API Error Response:', errorText);
                    
                    if (response.status === 403) {
                        throw new Error('API_KEY_INVALID: The provided API key is invalid or doesn\'t have permission to access this service.');
                    } else if (response.status === 429) {
                        throw new Error('RATE_LIMIT: API rate limit exceeded. Please try again later.');
                    } else {
                        throw new Error(`API_ERROR: HTTP ${response.status} - ${errorText}`);
                    }
                }

                const data = await response.json();
                console.log('ðŸ“„ API Response received:', data);
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                    analysisResult = data.candidates[0].content.parts[0].text;
                    console.log('âœ… Analysis extracted successfully, length:', analysisResult.length);
                    displayAnalysis(analysisResult);
                } else {
                    console.error('âŒ Invalid response structure:', data);
                    if (data.candidates && data.candidates[0] && data.candidates[0].finishReason) {
                        throw new Error(`AI_BLOCKED: AI response was blocked due to: ${data.candidates[0].finishReason}`);
                    }
                    throw new Error('INVALID_RESPONSE: No valid content found in API response');
                }

            } catch (error) {
                console.error('ðŸ’¥ Real AI analysis error:', error);
                
                // Provide more specific error handling
                if (error.message === 'Failed to fetch') {
                    throw new Error('NETWORK_ERROR: Cannot connect to AI service. This might be due to:\n' +
                                  'â€¢ Browser CORS restrictions\n' + 
                                  'â€¢ Network connectivity issues\n' +
                                  'â€¢ Firewall blocking the request\n\n' +
                                  'Recommendation: Use a backend server to proxy API requests.');
                }
                
                throw error;
            }
        }

        function getAnalysisPrompt(reportType) {
            const basePrompt = `You are a professional medical AI assistant specializing in ${reportType} analysis. Analyze this medical image and provide a comprehensive, detailed report.

Please structure your response with these exact sections:

**IMAGING TECHNIQUE**
Describe the imaging modality, technique, and image quality assessment.

**ANATOMICAL STRUCTURES**
Detail all visible anatomical structures and their appearances.

**FINDINGS**
Provide detailed observations of any abnormalities, variations, or notable features. If normal, clearly state this.

**IMPRESSION**
Summarize the key findings and their clinical significance.

**RECOMMENDATIONS**
Suggest appropriate follow-up or additional studies if needed.

Requirements:
- Be thorough and professional in your analysis
- Use appropriate medical terminology
- Focus on what you can observe in the image
- Be specific about locations, sizes, and characteristics of findings
- If image quality limits assessment, mention this
- Always include appropriate medical disclaimers
- Provide actionable recommendations when appropriate`;

            if (reportType === 'radiology') {
                return basePrompt + `\n\nThis is a radiology image (X-ray, CT, MRI, ultrasound, etc.). Focus on imaging-specific findings, anatomical visualization, and any pathological changes visible.`;
            } else {
                return basePrompt + `\n\nThis is a pathology/laboratory report. Focus on test values, reference ranges, and clinical significance of any abnormal results.`;
            }
        }

        async function performEnhancedSimulation(reportType) {
            // Enhanced fallback with more dynamic content
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            const timestamp = new Date().toLocaleString();
            const simulatedAnalysis = generateDynamicAnalysis(reportType, timestamp);
            
            analysisResult = simulatedAnalysis;
            displayAnalysis(analysisResult);
        }

        function generateDynamicAnalysis(reportType, timestamp) {
            const patientId = 'SAH' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            if (reportType === 'radiology') {
                return `**AI ANALYSIS REPORT**
Generated: ${timestamp} | Patient ID: ${patientId} | Status: Simulated Analysis

**IMAGING TECHNIQUE**
Image analysis performed using advanced AI algorithms optimized for medical imaging interpretation. The uploaded image has been processed for contrast enhancement, noise reduction, and anatomical structure identification.

**IMAGE QUALITY ASSESSMENT**
The provided image quality allows for adequate visualization of key anatomical structures. AI confidence level in analysis: Moderate to High.

**ANATOMICAL STRUCTURES IDENTIFIED**
Based on AI pattern recognition, the following structures appear to be visualized:
- Primary anatomical regions consistent with ${reportType} imaging
- Tissue density patterns within expected parameters
- Structural boundaries clearly delineated

**AI FINDINGS**
The AI analysis suggests:
- No immediately obvious acute abnormalities detected by automated screening
- Tissue patterns appear within typical variation ranges
- Recommend professional radiologist review for definitive interpretation

**CLINICAL CORRELATION**
This AI-generated analysis should be correlated with:
- Patient's clinical presentation and symptoms
- Laboratory findings and vital signs
- Previous imaging studies for comparison
- Physical examination findings

**RECOMMENDATIONS**
- Professional radiologist interpretation required for definitive diagnosis
- Clinical correlation with treating physician essential
- Consider follow-up imaging if clinically indicated
- Patient consultation for symptom correlation

**IMPORTANT DISCLAIMER**
This analysis was generated by AI technology and is for educational/screening purposes only. It does not replace professional medical interpretation by qualified radiologists.`;
            } else {
                return `**AI LABORATORY ANALYSIS REPORT**
Generated: ${timestamp} | Patient ID: ${patientId} | Status: Simulated Analysis

**METHODOLOGY**
Advanced AI optical character recognition and pattern analysis applied to laboratory report image. Values extracted using medical AI algorithms.

**DETECTED PARAMETERS**
AI has identified multiple laboratory parameters in the uploaded image:
- Numerical values detected and parsed
- Reference ranges identified where visible
- Abnormal flags processed

**AI INTERPRETATION**
Based on pattern recognition:
- Most values appear to fall within typical reference ranges
- Any values outside normal limits require clinical correlation
- Trends analysis not possible without historical data

**CLINICAL SIGNIFICANCE**
The AI suggests correlation with:
- Patient's current symptoms and clinical presentation
- Medication history and dietary factors
- Hydration status and recent activities
- Previous laboratory results for trending

**RECOMMENDATIONS**
- Professional laboratory interpretation recommended
- Abnormal values require clinical correlation
- Repeat testing may be indicated based on clinical context
- Consult with ordering physician for comprehensive evaluation

**QUALITY ASSURANCE**
AI confidence in optical character recognition: Moderate
Recommend verification of critical values with original laboratory report

**IMPORTANT DISCLAIMER**
This AI analysis is for informational purposes only and does not constitute medical advice. Always consult with qualified healthcare professionals for proper interpretation.`;
            }
        }

        function displayAnalysis(analysis) {
            const content = document.getElementById('analysisContent');
            const formattedAnalysis = analysis
                .replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>')
                .replace(/\*(.*?)\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n- /g, '<li>')
                .replace(/\n/g, '<br>');
            
            content.innerHTML = `<p>${formattedAnalysis}</p>`;
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function exportToPDF() {
            if (!analysisResult) {
                alert('Please analyze a report first before exporting.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set Times New Roman font
                doc.setFont('times', 'normal');
                
                // Header with nice colors
                doc.setFontSize(24);
                doc.setFont('times', 'bold');
                doc.setTextColor(30, 60, 114);
                doc.text('Sahawas AI', 105, 25, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setFont('times', 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text('Medical Report Analysis', 105, 35, { align: 'center' });
                
                // Add timestamp
                const timestamp = new Date().toLocaleDateString();
                doc.setFontSize(10);
                doc.text(`Generated: ${timestamp}`, 105, 45, { align: 'center' });
                
                // Add a nice line
                doc.setDrawColor(0, 188, 212);
                doc.setLineWidth(0.5);
                doc.line(20, 50, 190, 50);
                
                // Analysis content
                doc.setFontSize(12);
                doc.setFont('times', 'normal');
                doc.setTextColor(51, 51, 51);
                
                // Clean and format content for PDF
                let cleanContent = analysisResult
                    .replace(/\*\*(.*?)\*\*/g, '\n$1\n')
                    .replace(/\*(.*?)\*/g, '$1')
                    .replace(/\n\n+/g, '\n')
                    .trim();
                
                // Split content into pages
                const lines = doc.splitTextToSize(cleanContent, 170);
                let yPosition = 60;
                const lineHeight = 6;
                const pageHeight = doc.internal.pageSize.height;
                const marginBottom = 50;
                
                for (let i = 0; i < lines.length; i++) {
                    if (yPosition + lineHeight > pageHeight - marginBottom) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    // Check if it's a heading (section title)
                    if (lines[i].match(/^[A-Z\s]+$/)) {
                        doc.setFont('times', 'bold');
                        doc.setFontSize(14);
                    } else {
                        doc.setFont('times', 'normal');
                        doc.setFontSize(12);
                    }
                    
                    doc.text(lines[i], 20, yPosition);
                    yPosition += lineHeight;
                }
                
                // Footer on last page
                const currentPageHeight = doc.internal.pageSize.height;
                
                // Footer background
                doc.setFillColor(240, 248, 255);
                doc.rect(0, currentPageHeight - 45, 210, 45, 'F');
                
                // Footer content
                doc.setFontSize(11);
                doc.setFont('times', 'bold');
                doc.setTextColor(30, 60, 114);
                doc.text('For real-time consultation contact:', 20, currentPageHeight - 35);
                
                doc.setFont('times', 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text('Dr. Sunil Sangle - Sahawas Hospital', 20, currentPageHeight - 28);
                doc.text('Address: Peth Road, Nashik', 20, currentPageHeight - 21);
                doc.text('Phone: 9260692607', 20, currentPageHeight - 14);
                
                // Disclaimer
                doc.setFontSize(9);
                doc.setTextColor(128, 128, 128);
                doc.setFont('times', 'italic');
                doc.text('Disclaimer: This is an AI-generated analysis and not a substitute for professional medical advice.', 105, currentPageHeight - 5, { align: 'center' });
                
                // Save with timestamp
                const fileTimestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                doc.save(`Sahawas-AI-Analysis-${fileTimestamp}.pdf`);
                
                console.log('PDF exported successfully');
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('Error exporting PDF. Please try again.');
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sahawas AI Medical Report Analysis loaded successfully');
            console.log('âœ… Real AI Analysis: Enabled with Gemini API');
            console.log('ðŸ”¬ Ready to analyze medical reports with AI');
        });
    </script>
</body>
</html>